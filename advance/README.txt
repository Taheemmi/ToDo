This is all of the code, together. The nested advance has split the code up for easier reading
